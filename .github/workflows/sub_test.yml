name: (level 2 sub) Test

on:
  workflow_call:
    inputs:
      INTERMEDIATE_IMAGES_BUILDS_REGISTRY:
        required: true
        type: string
      IMAGE_NAME:
        required: true
        type: string
      IMAGE_VERSION:
        required: false
        type: string
      ARCH:
        required: true
        type: string

jobs:
  test:
    timeout-minutes: 5
    name: Test image (${{ inputs.ARCH }})
    runs-on:
      - self-hosted
      - tester
      - ${{ inputs.ARCH }}
    steps:
      - name: (dbg) inspect the image
        run: docker inspect ${{ inputs.INTERMEDIATE_IMAGES_BUILDS_REGISTRY }}:${{ inputs.IMAGE_NAME }}-${{ inputs.IMAGE_VERSION }}-${{ inputs.ARCH }}
      - name: Create a container from the built image
        run: |
          docker run --name exegol-${{ inputs.IMAGE_NAME }}-${{ inputs.IMAGE_VERSION }}-${{ inputs.ARCH }} --rm -t -d ${{ inputs.INTERMEDIATE_IMAGES_BUILDS_REGISTRY }}:${{ inputs.IMAGE_NAME }}-${{ inputs.IMAGE_VERSION }}-${{ inputs.ARCH }} endless
      - name: Run the tests
        if: success()
        run: |
          docker exec exegol-${{ inputs.IMAGE_NAME }}-${{ inputs.IMAGE_VERSION }}-${{ inputs.ARCH }} zsh -c 'cat /.exegol/build_pipeline_tests/all_commands.txt | grep -vE "^\s*$" | sort -u > /.exegol/build_pipeline_tests/all_commands.sorted.txt'
          docker exec exegol-${{ inputs.IMAGE_NAME }}-${{ inputs.IMAGE_VERSION }}-${{ inputs.ARCH }} python3 /.exegol/build_pipeline_tests/run_tests.py
      - name: Print the failed tests if any
        if: failure()
        run: |
          docker exec exegol-${{ inputs.IMAGE_NAME }}-${{ inputs.IMAGE_VERSION }}-${{ inputs.ARCH }} cat /.exegol/build_pipeline_tests/failed_commands.log
      - name: Print the successful tests
        if: always()
        run: |
          docker exec exegol-${{ inputs.IMAGE_NAME }}-${{ inputs.IMAGE_VERSION }}-${{ inputs.ARCH }} cat /.exegol/build_pipeline_tests/success_commands.log
      - name: Stop the container
        if: always()
        run: docker stop exegol-${{ inputs.IMAGE_NAME }}-${{ inputs.IMAGE_VERSION }}-${{ inputs.ARCH }}
